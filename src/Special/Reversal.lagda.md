---
title: Reversal of formal series ğŸš§
---

```
{-# OPTIONS --guardedness --sized-types #-}
-- {-# OPTIONS --allow-unsolved-metas #-}

open import Preliminaries.Base hiding (_++_)
open import General.ProductRules

module Special.Reversal
    (R : CommutativeRing)
    (Î£ : Set)
    (P : ProductRule R)
    where

open import Size
open import Preliminaries.Algebra R
open import Preliminaries.PolyExpr R
    using (PolyExpr; con)
    renaming (subst to P-subst; âŸ¦_âŸ§_ to PâŸ¦_âŸ§_)

open import General.Series R Î£
open import General.Terms R renaming (_+_ to _[+]_; _*_ to _[*]_; _Â·_ to _[Â·]_) hiding (x; y)
open import General.Products R Î£
open import General.Reversal R Î£

open Product P
open Reversal P

private variable
    i : Size
    n : â„•
```

We show that the properties `P-Rev` and `U-Rev` can be decided
in the case of special products.

```
-- -- module _ (f g : A âŸª Î£ âŸ«) where
open Inductive
open import General.Automata R Î£ P

infix 8 _x[_]_
data *X* : Set where
    _x[_]_ : (u : Î£ *) (f : A âŸª Î£ âŸ«) (v : Î£ *) â†’ *X*

Î”Ë¡ Î”Ê³ : (a : Î£) â†’ *X* â†’ Term *X*
Î”Ë¡ a (u x[ f ] v) = var ((u âˆ·Ê³ a) x[ f ] v)
Î”Ê³ b (u x[ f ] v) = var (u x[ f ] (v âˆ·Ê³ b))

S : TermAut *X*
F S (u x[ f ] v) = f âŸ¨ u ++ reverse v âŸ©
Î” S = Î”Ë¡

var-lemma-coeff :
    âˆ€ u f v w â†’
    --------------------------------------------------------
    S âŸ¦ var (u x[ f ] v) âŸ§ âŸ¨ w âŸ© â‰¡ f âŸ¨ u ++ w ++ reverse v âŸ©

var-lemma-coeff u f v Îµ = refl
var-lemma-coeff u f v (a âˆ· w) =
    begin
        S âŸ¦ var (u x[ f ] v) âŸ§ âŸ¨ a âˆ· w âŸ©
            â‰¡âŸ¨âŸ©            
        Î´ (S âŸ¦ var (u x[ f ] v) âŸ§) a âŸ¨ w âŸ©
            â‰¡âŸ¨âŸ©
        S âŸ¦ var ((u âˆ·Ê³ a) x[ f ] v) âŸ§ âŸ¨ w âŸ©
            â‰¡âŸ¨ var-lemma-coeff _ _ _ w âŸ©
        f âŸ¨ (u âˆ·Ê³ a) ++ w ++ reverse v âŸ©
            â‰¡âŸ¨ cong (Î» w â†’ f âŸ¨ w âŸ©) (âˆ·Ê³-++-++ u a w (reverse v)) âŸ©
        f âŸ¨ u ++ a âˆ· w ++ reverse v âŸ©
    âˆ where open â‰¡-Eq

-- semantics of a variable
var-lemma : âˆ€ u f v â†’
    ----------------------------------------
    S âŸ¦ var (u x[ f ] v) âŸ§ â‰ˆ Î´Ë¡* u (Î´Ê³* v f)

var-lemma u f v = series-ext Î» w â†’ EqR.â‰¡â†’â‰ˆ (helper w) where

    helper : âˆ€ w â†’ S âŸ¦ var (u x[ f ] v) âŸ§ âŸ¨ w âŸ© â‰¡ Î´Ë¡* u (Î´Ê³* v f) âŸ¨ w âŸ©
    helper w =
        begin
            S âŸ¦ var (u x[ f ] v) âŸ§ âŸ¨ w âŸ© â‰¡âŸ¨ var-lemma-coeff u f v w âŸ©
            f âŸ¨ u ++ w ++ reverse v âŸ© â‰¡âŸ¨ coeff-Î´Ë¡*-Î´Ê³* u v f w âŸ¨
            Î´Ë¡* u (Î´Ê³* v f) âŸ¨ w âŸ©
        âˆ where open â‰¡-Eq

module _ 
    (ass-* : P-Rev)
    where

    -- swap rule
    lem :
        âˆ€ b Î± â†’
        ------------------------------
        Î´Ê³ b (S âŸ¦ Î± âŸ§) â‰ˆ S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§

    lem b 0T =
        begin
            Î´Ê³ b (S âŸ¦ 0T âŸ§)
                â‰ˆâŸ¨ Î´Ê³-cong b (sem-ğŸ˜ S) âŸ©
            Î´Ê³ b ğŸ˜
                â‰ˆâŸ¨ Î´Ê³-end-ğŸ˜ b âŸ©
            ğŸ˜
                â‰ˆâŸ¨ sem-ğŸ˜ S âŸ¨
            S âŸ¦ 0T âŸ§
        âˆ where open EqS
       
    lem b (c [Â·] p) =
        begin
            Î´Ê³ b (S âŸ¦ c [Â·] p âŸ§)
                â‰ˆâŸ¨ Î´Ê³-cong b (sem-Â· S c p) âŸ©
            Î´Ê³ b (c Â· S âŸ¦ p âŸ§)
                â‰ˆâŸ¨ Î´Ê³-end-Â· _ _ _ âŸ©
            c Â· Î´Ê³ b (S âŸ¦ p âŸ§)
                â‰ˆâŸ¨ Â·-cong R-refl (lem b p) âŸ©
            c Â· S âŸ¦ Î”Ê³ b â†‘ p âŸ§
                â‰ˆâŸ¨ sem-Â· S _ _ âŸ¨
            S âŸ¦ c [Â·] Î”Ê³ b â†‘ p âŸ§
                â‰ˆâŸ¨âŸ©
            S âŸ¦ Î”Ê³ b â†‘ (c [Â·] p) âŸ§
        âˆ where open EqS

    lem b (var (u x[ f ] v)) =
        begin
            Î´Ê³ b (S âŸ¦ var (u x[ f ] v) âŸ§)
                â‰ˆâŸ¨ Î´Ê³-cong b (var-lemma u f v) âŸ©
            Î´Ê³ b (Î´Ë¡* u (Î´Ê³* v f))
                â‰ˆâŸ¨ Î´Ê³-Î´Ë¡* _ b u âŸ©
            Î´Ë¡* u (Î´Ê³ b (Î´Ê³* v f))
                â‰¡âŸ¨ cong (Î´Ë¡* u) (Î´Ê³-Î´Ê³* b v f) âŸ©
            Î´Ë¡* u (Î´Ê³* (v âˆ·Ê³ b) f)
                â‰ˆâŸ¨ â‰ˆ-sym (var-lemma _ _ _) âŸ©
            S âŸ¦ var (u x[ f ] (v âˆ·Ê³ b)) âŸ§
                â‰ˆâŸ¨âŸ©
            S âŸ¦ Î”Ê³ b â†‘ var (u x[ f ] v) âŸ§
        âˆ where open EqS

    lem b (Î± [+] Î²) =
        begin
            Î´Ê³ b (S âŸ¦ Î± [+] Î² âŸ§)
                â‰ˆâŸ¨ Î´Ê³-cong b (sem-+ S) âŸ©
            Î´Ê³ b (S âŸ¦ Î± âŸ§ + S âŸ¦ Î² âŸ§)
                â‰ˆâŸ¨ Î´Ê³-end-+ _ _ _ âŸ©
            Î´Ê³ b (S âŸ¦ Î± âŸ§) + Î´Ê³ b (S âŸ¦ Î² âŸ§)
                â‰ˆâŸ¨ +-cong (lem _ _) (lem _ _) âŸ©
            S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§ + S âŸ¦ Î”Ê³ b â†‘ Î² âŸ§
                â‰ˆâŸ¨ sem-+ S âŸ¨
            S âŸ¦ Î”Ê³ b â†‘ (Î± [+] Î²) âŸ§
        âˆ where open EqS

    lem b (Î± [*] Î²) =
        begin
            Î´Ê³ b (S âŸ¦ Î± [*] Î² âŸ§)
                â‰ˆâŸ¨ Î´Ê³-cong b (sem-* S) âŸ©
            Î´Ê³ b (S âŸ¦ Î± âŸ§ * S âŸ¦ Î² âŸ§)
                â‰ˆâŸ¨ ass-* _ _ _ âŸ©
            âŸ¦ P âŸ§áµ¥ (S âŸ¦ Î± âŸ§ âˆ· Î´Ê³ b (S âŸ¦ Î± âŸ§) âˆ· S âŸ¦ Î² âŸ§ âˆ· Î´Ê³ b (S âŸ¦ Î² âŸ§) âˆ· [])
                â‰ˆâŸ¨ âŸ¦ P âŸ§â‰ˆáµ¥ [ â‰ˆ-refl , lem b Î± , â‰ˆ-refl , lem b Î² ] âŸ©
            âŸ¦ P âŸ§áµ¥ (S âŸ¦ Î± âŸ§ âˆ· S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§ âˆ· S âŸ¦ Î² âŸ§ âˆ· S âŸ¦ Î”Ê³ b â†‘ Î² âŸ§ âˆ· [])
                â‰ˆâŸ¨ sem-substáµ¥ S P (_ âˆ· _ âˆ· _ âˆ· _ âˆ· []) âŸ¨
            S âŸ¦ [ P ]âŸ¨ Î± , Î”Ê³ b â†‘ Î± , Î² , Î”Ê³ b â†‘ Î² âŸ© âŸ§
                â‰ˆâŸ¨âŸ©
            S âŸ¦ Î”Ê³ b â†‘ (Î± [*] Î²) âŸ§
        âˆ where open EqS

module _ 
    (ass-Î”Ê³ : âˆ€ b Î± â†’ Î´Ê³ b (S âŸ¦ Î± âŸ§) â‰ˆ S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§)
    where

    lem1 :
        âˆ€ a b Î± â†’
        ------------------------------------------------
        S âŸ¦ Î”Ê³ b â†‘ (Î”Ë¡ a â†‘ Î±) âŸ§ â‰ˆ S âŸ¦ Î”Ë¡ a â†‘ (Î”Ê³ b â†‘ Î±) âŸ§

    lem1 a b Î± =
        begin
            S âŸ¦ Î”Ê³ b â†‘ (Î”Ë¡ a â†‘ Î±) âŸ§ â‰ˆâŸ¨ ass-Î”Ê³ _ _ âŸ¨
            Î´Ê³ b (S âŸ¦ Î”Ë¡ a â†‘ Î± âŸ§) â‰ˆâŸ¨âŸ©
            Î´Ê³ b (Î´Ë¡ a (S âŸ¦ Î± âŸ§)) â‰ˆâŸ¨âŸ©
            Î´Ë¡ a (Î´Ê³ b (S âŸ¦ Î± âŸ§)) â‰ˆâŸ¨ Î´-â‰ˆ (ass-Î”Ê³ _ Î±) a âŸ©
            Î´Ë¡ a (S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§) â‰ˆâŸ¨âŸ©
            S âŸ¦ Î”Ë¡ a â†‘ (Î”Ê³ b â†‘ Î±) âŸ§
        âˆ where open EqS

module _
    (ass-Î”Ê³-Î”Ë¡ : âˆ€ a b Î± â†’ S âŸ¦ Î”Ê³ b â†‘ (Î”Ë¡ a â†‘ Î±) âŸ§ â‰ˆ S âŸ¦ Î”Ë¡ a â†‘ (Î”Ê³ b â†‘ Î±) âŸ§)
    where

    open Semantics renaming (âŸ¦_âŸ§_ to TâŸ¦_âŸ§_; âŸ¦_âŸ§âŸ¨_,_,_,_âŸ© to TâŸ¦_âŸ§âŸ¨_,_,_,_âŸ©)

    Î´Ê³-Î”Ê³-Î½-var :
        âˆ€ b u f v â†’
        --------------------------------------------------------------------
        Î½ (Î´Ê³ b (S âŸ¦ var (u x[ f ] v) âŸ§)) â‰¡ Î½ (S âŸ¦ Î”Ê³ b â†‘ var (u x[ f ] v) âŸ§)

    Î´Ê³-Î”Ê³-Î½-var b u f v =
        begin
            Î½ (Î´Ê³ b (S âŸ¦ var (u x[ f ] v) âŸ§)) â‰¡âŸ¨âŸ©
            Î½ (Î´Ë¡ b (S âŸ¦ var (u x[ f ] v) âŸ§)) â‰¡âŸ¨âŸ©
            Î½ (S âŸ¦ Î”Ë¡ b â†‘ var (u x[ f ] v) âŸ§) â‰¡âŸ¨âŸ©
            Î½ (S âŸ¦ var ((u âˆ·Ê³ b) x[ f ] v) âŸ§) â‰¡âŸ¨âŸ©
            f âŸ¨ (u âˆ·Ê³ b) ++ reverse v âŸ© â‰¡âŸ¨ (cong (Î» x â†’ f âŸ¨ x âŸ©) $ reverse-âˆ·Ê³-++ u v b) âŸ©
            f âŸ¨ u ++ reverse (v âˆ·Ê³ b) âŸ© â‰¡âŸ¨âŸ©
            Î½ (S âŸ¦ var (u x[ f ] (v âˆ·Ê³ b)) âŸ§) â‰¡âŸ¨âŸ©
            Î½ (S âŸ¦ Î”Ê³ b â†‘ var (u x[ f ] v) âŸ§)
        âˆ where open â‰¡-Eq

    Î´Ê³-Î”Ê³-Î½ :
        âˆ€ b Î± â†’
        ---------------------------------------
        Î½ (Î´Ê³ b (S âŸ¦ Î± âŸ§)) â‰ˆR Î½ (S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§)

    Î´Ê³-Î”Ê³-Î½ b 0T = R-refl

    Î´Ê³-Î”Ê³-Î½ b (var (u x[ f ] v)) = EqR.â‰¡â†’â‰ˆ (Î´Ê³-Î”Ê³-Î½-var b u f v)

    Î´Ê³-Î”Ê³-Î½ b (c [Â·] Î±) =
        begin
            Î½ (Î´Ê³ b (S âŸ¦ c [Â·] Î± âŸ§))
                â‰ˆâŸ¨âŸ©
            Î½ (Î´Ë¡ b (S âŸ¦ c [Â·] Î± âŸ§))
                â‰ˆâŸ¨âŸ©
            Î½ (S âŸ¦ Î”Ë¡ b â†‘ (c [Â·] Î±) âŸ§)
                â‰ˆâŸ¨âŸ©
            Î½ (S âŸ¦ c [Â·] Î”Ë¡ b â†‘ Î± âŸ§)
                â‰ˆâŸ¨ (Î½-â‰ˆ $ sem-Â· S c (Î”Ë¡ b â†‘ Î±)) âŸ©
            Î½ (c Â· S âŸ¦ Î”Ë¡ b â†‘ Î± âŸ§)
                â‰ˆâŸ¨âŸ©
            Î½ (c Â· Î´Ë¡ b (S âŸ¦ Î± âŸ§))
                â‰ˆâŸ¨âŸ©
            c *R Î½ (Î´Ë¡ b (S âŸ¦ Î± âŸ§))
                â‰ˆâŸ¨âŸ©
            c *R Î½ (Î´Ê³ b (S âŸ¦ Î± âŸ§))
                â‰ˆâŸ¨ R-refl âŸ¨ *R-cong âŸ© Î´Ê³-Î”Ê³-Î½ b Î± âŸ©
            c *R Î½ (S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§)
                â‰ˆâŸ¨âŸ©
            Î½ (c Â· S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§)
                â‰ˆâŸ¨âŸ©
            Î½ (S âŸ¦ c [Â·] Î”Ê³ b â†‘ Î± âŸ§)
                â‰ˆâŸ¨âŸ©
            Î½ (S âŸ¦ Î”Ê³ b â†‘ (c [Â·] Î±) âŸ§)
        âˆ where open EqR

    Î´Ê³-Î”Ê³-Î½ b (Î± [+] Î²) =
        begin
            Î½ (Î´Ê³ b (S âŸ¦ Î± [+] Î² âŸ§)) â‰ˆâŸ¨ Î½-â‰ˆ (Î´Ê³-cong b (sem-+ S {Î±} {Î²})) âŸ© 
            Î½ (Î´Ê³ b (S âŸ¦ Î± âŸ§ + S âŸ¦ Î² âŸ§)) â‰ˆâŸ¨âŸ© 
            Î½ (Î´Ê³ b (S âŸ¦ Î± âŸ§) + Î´Ê³ b (S âŸ¦ Î² âŸ§)) â‰ˆâŸ¨âŸ© 
            Î½ (Î´Ê³ b (S âŸ¦ Î± âŸ§)) +R Î½ (Î´Ê³ b (S âŸ¦ Î² âŸ§)) â‰ˆâŸ¨ +R-cong (Î´Ê³-Î”Ê³-Î½ b Î±) (Î´Ê³-Î”Ê³-Î½ b Î²) âŸ© 
            Î½ (S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§) +R Î½ (S âŸ¦ Î”Ê³ b â†‘ Î² âŸ§) â‰ˆâŸ¨âŸ© 
            Î½ (S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§ + S âŸ¦ Î”Ê³ b â†‘ Î² âŸ§) â‰ˆâŸ¨ Î½-â‰ˆ (sem-+ S {Î”Ê³ b â†‘ Î±} {Î”Ê³ b â†‘ Î²}) âŸ©
            Î½ (S âŸ¦ Î”Ê³ b â†‘ Î± [+] Î”Ê³ b â†‘ Î² âŸ§) â‰ˆâŸ¨âŸ© 
            Î½ (S âŸ¦ Î”Ê³ b â†‘ (Î± [+] Î²) âŸ§)
        âˆ where open EqR

    Î´Ê³-Î”Ê³-Î½ b (Î± [*] Î²) =
        let Ï±Ë¡ = Î± âˆ· Î”Ë¡ b â†‘ Î± âˆ· Î² âˆ· Î”Ë¡ b â†‘ Î² âˆ· []
            Ï±Ê³ = Î± âˆ· Î”Ê³ b â†‘ Î± âˆ· Î² âˆ· Î”Ê³ b â†‘ Î² âˆ· [] in
        begin
            Î½ (Î´Ê³ b (S âŸ¦ Î± [*] Î² âŸ§)) â‰ˆâŸ¨âŸ©
            Î½ (Î´Ë¡ b (S âŸ¦ Î± [*] Î² âŸ§)) â‰ˆâŸ¨âŸ©  -- !
            Î½ (S âŸ¦ Î”Ë¡ b â†‘ (Î± [*] Î²) âŸ§) â‰ˆâŸ¨âŸ©
            Î½ (S âŸ¦ [ P ]âŸ¨ Î± , Î”Ë¡ b â†‘ Î± , Î² , Î”Ë¡ b â†‘ Î² âŸ© âŸ§) â‰ˆâŸ¨ Î½-â‰ˆ (sem-substáµ¥ S P Ï±Ë¡) âŸ©
            Î½ (âŸ¦ P âŸ§âŸ¨ S âŸ¦ Î± âŸ§ , S âŸ¦ Î”Ë¡ b â†‘ Î± âŸ§ , S âŸ¦ Î² âŸ§ , S âŸ¦ Î”Ë¡ b â†‘ Î² âŸ§ âŸ©)
                â‰ˆâŸ¨ Î½-homáµ¥ P (_ âˆ· _ âˆ· _ âˆ· _) âŸ©
            TâŸ¦ P âŸ§âŸ¨ Î½ (S âŸ¦ Î± âŸ§) , Î½ (S âŸ¦ Î”Ë¡ b â†‘ Î± âŸ§) , Î½ (S âŸ¦ Î² âŸ§) , Î½ (S âŸ¦ Î”Ë¡ b â†‘ Î² âŸ§) âŸ©
                â‰ˆâŸ¨âŸ©
            TâŸ¦ P âŸ§âŸ¨ Î½ (S âŸ¦ Î± âŸ§) , Î½ (Î´Ë¡ b (S âŸ¦ Î± âŸ§)) , Î½ (S âŸ¦ Î² âŸ§) , Î½ (Î´Ë¡ b (S âŸ¦ Î² âŸ§)) âŸ©
                â‰ˆâŸ¨âŸ©
            TâŸ¦ P âŸ§âŸ¨ Î½ (S âŸ¦ Î± âŸ§) , Î½ (Î´Ê³ b (S âŸ¦ Î± âŸ§)) , Î½ (S âŸ¦ Î² âŸ§) , Î½ (Î´Ê³ b (S âŸ¦ Î² âŸ§)) âŸ©
                â‰ˆâŸ¨ âŸ¦ P âŸ§â‰ˆâŸ¨ R-refl , Î´Ê³-Î”Ê³-Î½ b Î± , R-refl , Î´Ê³-Î”Ê³-Î½ b Î² âŸ© âŸ© -- induction
            TâŸ¦ P âŸ§âŸ¨ Î½ (S âŸ¦ Î± âŸ§) , Î½ (S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§) , Î½ (S âŸ¦ Î² âŸ§) , Î½ (S âŸ¦ Î”Ê³ b â†‘ Î² âŸ§) âŸ©
                â‰ˆâŸ¨ Î½-homáµ¥ P (_ âˆ· _ âˆ· _ âˆ· _) âŸ¨
            Î½ (âŸ¦ P âŸ§âŸ¨ S âŸ¦ Î± âŸ§ , S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§ , S âŸ¦ Î² âŸ§ , S âŸ¦ Î”Ê³ b â†‘ Î² âŸ§ âŸ©) â‰ˆâŸ¨ Î½-â‰ˆ (sem-substáµ¥ S P Ï±Ê³) âŸ¨
            Î½ (S âŸ¦ [ P ]âŸ¨ Î± , Î”Ê³ b â†‘ Î± , Î² , Î”Ê³ b â†‘ Î² âŸ© âŸ§) â‰ˆâŸ¨âŸ©
            Î½ (S âŸ¦ Î”Ê³ b â†‘ (Î± [*] Î²) âŸ§)
        âˆ where open EqR

    -- in equality proofs by coinduction we need to use the size parameter i
    Î´Ê³-Î”Ê³ : âˆ€ b Î± â†’ Î´Ê³ b (S âŸ¦ Î± âŸ§) â‰ˆ[ i ] S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§
    Î½-â‰ˆ (Î´Ê³-Î”Ê³ b Î±) = Î´Ê³-Î”Ê³-Î½ b Î±
    Î´-â‰ˆ (Î´Ê³-Î”Ê³ b Î±) a =
        begin
            Î´Ë¡ a (Î´Ê³ b (S âŸ¦ Î± âŸ§)) â‰ˆâŸ¨âŸ©
            Î´Ê³ b (Î´Ë¡ a (S âŸ¦ Î± âŸ§)) â‰ˆâŸ¨âŸ©
            Î´Ê³ b (S âŸ¦ Î”Ë¡ a â†‘ Î± âŸ§) â‰ˆâŸ¨ Î´Ê³-Î”Ê³ b (Î”Ë¡ a â†‘ Î±) âŸ©
            S âŸ¦ Î”Ê³ b â†‘ (Î”Ë¡ a â†‘ Î±) âŸ§ â‰ˆâŸ¨ ass-Î”Ê³-Î”Ë¡ a b Î± âŸ©
            S âŸ¦ Î”Ë¡ a â†‘ (Î”Ê³ b â†‘ Î±) âŸ§ â‰ˆâŸ¨âŸ©
            Î´Ë¡ a (S âŸ¦ Î”Ê³ b â†‘ Î± âŸ§)
        âˆ where open EqS
```