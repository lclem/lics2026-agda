---
title: "`P`-finite series ğŸš§"
---

```
{-# OPTIONS --guardedness --sized-types #-}
```

In this section we define the class of *`P`-finite* series,
which are series that belong to a finitely generated algebra of series
that is closed under left derivatives.

To this end, we fix the coefficient ring `R`, the alphabet `Î£`,
and a product rule `P`.

```
open import Preliminaries.Base renaming (_,,_ to _,_)
open import General.ProductRules

module General.FinitelyGenerated
    (R : CommutativeRing)
    (Î£ : Set)
    (P : ProductRule R)
    where
```

```
open import Size

open import Preliminaries.Vector
open import Preliminaries.Algebra R

open import General.Terms R
    renaming (_+_ to _[+]_; _*_ to _[*]_; _Â·_ to _[Â·]_)

open import General.Series R Î£
open import General.Products R Î£
open Product P

private variable
    X : Set
    m n : â„•
    c : A
    f g h : A âŸª Î£ âŸ«
    gs : Vec (A âŸª Î£ âŸ«) n
```

# Finitely genereated algebras of series

For a series `f` and a vector of generators `gs`,
we write `f âˆˆ[ gs ]` to denote that `f` can be obtained from the generators `gs` by a finite sequence of algebra operations.

```
infix 4 _âˆˆ[_] [_]âˆ‹_
infixr 8 _Â·âˆˆ_
infixr 6 _+âˆˆ_
infixr 7 _*âˆˆ_
infixr 8 _â‰ˆâˆˆ_

data [_]âˆ‹_ (gs : Vec (A âŸª Î£ âŸ«) n) : A âŸª Î£ âŸ« â†’ Set where
    ğŸ˜âˆˆ : [ gs ]âˆ‹ ğŸ˜
    genâˆˆ : g âˆˆ gs â†’ [ gs ]âˆ‹ g
    _Â·âˆˆ_ : âˆ€ c â†’ [ gs ]âˆ‹ f â†’ [ gs ]âˆ‹ c Â· f
    _+âˆˆ_ : [ gs ]âˆ‹ f â†’ [ gs ]âˆ‹ g â†’ [ gs ]âˆ‹ f + g
    _*âˆˆ_ : [ gs ]âˆ‹ f â†’ [ gs ]âˆ‹ g â†’ [ gs ]âˆ‹ f * g
    -- closure under equivalence of series
    -- we need to assume this since the base ring is parametrised by an equivalence relation
    _â‰ˆâˆˆ_ : f â‰ˆ g â†’ [ gs ]âˆ‹ g â†’ [ gs ]âˆ‹ f

_âˆˆ[_] : (f : A âŸª Î£ âŸ«) (gs : Vec (A âŸª Î£ âŸ«) n) â†’ Set
f âˆˆ[ gs ] = [ gs ]âˆ‹ f
```

If `Ï±` is an environment mapping variables to series in the algebra generated by `gs`,
then also `âŸ¦ p âŸ§ Ï±` belongs to this algebra.

In other words, the algebra generated by `gs` is closed under the algebra operations.

```
subalgebra :
    âˆ€ {Ï±} (p : Term X) â†’
    (âˆ€ x â†’ Ï± x âˆˆ[ gs ]) â†’
    ---------------------
    âŸ¦ p âŸ§ Ï± âˆˆ[ gs ]

subalgebra 0T _ = ğŸ˜âˆˆ
subalgebra (var x) ass = ass x
subalgebra (c [Â·] p) ass = _ Â·âˆˆ subalgebra p ass
subalgebra (p [+] q) ass = subalgebra p ass +âˆˆ subalgebra q ass
subalgebra (p [*] q) ass = subalgebra p ass *âˆˆ subalgebra q ass
```

Viceversa, for every element in the algebra generated by `gs`
we can compute a term witnessing membership.

```
extract :
    âˆ€ f (gs : Vec (A âŸª Î£ âŸ«) n) â†’
    f âˆˆ[ gs ] â†’
    ----------------------------
    âˆƒ[ Î± ] f â‰ˆ âŸ¦ Î± âŸ§ (lookup gs)
```

```
extract {n} f gs fâˆˆ[gs] = go f fâˆˆ[gs] where

    -- there are n variables
    Y : Set
    Y = Fin n

    -- if f belongs to a finitely generated algebra,
    -- then it can be expressed as a polynomial in the generators
    go : âˆ€ f â†’ f âˆˆ[ gs ] â†’ âˆƒ[ Î± ] f â‰ˆ âŸ¦ Î± âŸ§ (lookup gs)
    go f ğŸ˜âˆˆ = 0T , â‰ˆ-refl
    go f (genâˆˆ fâˆˆgs) = var i , fâ‰ˆâŸ¦iâŸ§Ï± where

        -- index of f in gs
        i : Y
        i with lookup-âˆˆ fâˆˆgs
        ... | i , _ = i

        -- proof that f indeed is element i of gsâ€²
        fâ‰¡Ï±i : f â‰¡ lookup gs i
        fâ‰¡Ï±i with lookup-âˆˆ fâˆˆgs
        ... | _ , eq = eq

        fâ‰ˆâŸ¦iâŸ§Ï± : f â‰ˆ âŸ¦ var i âŸ§ (lookup gs)
        fâ‰ˆâŸ¦iâŸ§Ï± = â‰¡â†’â‰ˆ fâ‰¡Ï±i

    go f (c Â·âˆˆ fâˆˆ[gs])
        with go _ fâˆˆ[gs]
    ... | Î± , fâ‰ˆâŸ¦Î±âŸ§ = c [Â·] Î± , Â·-cong R-refl fâ‰ˆâŸ¦Î±âŸ§

    go f (fâˆˆ[gs] +âˆˆ gâˆˆ[gs])
        with go _ fâˆˆ[gs] | go _ gâˆˆ[gs]
    ... | Î± , fâ‰ˆâŸ¦Î±âŸ§ | Î² , gâ‰ˆâŸ¦Î²âŸ§ = Î± [+] Î² , +-cong fâ‰ˆâŸ¦Î±âŸ§ gâ‰ˆâŸ¦Î²âŸ§
    
    go f (fâˆˆ[gs] *âˆˆ gâˆˆ[gs])
        with go _ fâˆˆ[gs] | go _ gâˆˆ[gs]
    ... | Î± , fâ‰ˆâŸ¦Î±âŸ§ | Î² , gâ‰ˆâŸ¦Î²âŸ§ = Î± [*] Î² , *-cong fâ‰ˆâŸ¦Î±âŸ§ gâ‰ˆâŸ¦Î²âŸ§

    go f (fâ‰ˆg â‰ˆâˆˆ fâˆˆ[gs])
        with go _ fâˆˆ[gs]
    ... | Î± , gâ‰ˆâŸ¦Î±âŸ§ = Î± , â‰ˆ-trans fâ‰ˆg gâ‰ˆâŸ¦Î±âŸ§
```

# `P`-finite series {#sec:P-finite}

We present two, equivalent, definitions for `P`-finite series.
One is more intuitive, while the other is more convenient to work with.

## Official definition

We start with the intuitive definition.
We say that a series is `P`-finite if it belongs to a finitely generated algebra of series that is closed under left derivatives.
This is formalised as follows.

```
module OfficialDefinition where

    infix 3 P-fin[_,_,_]
    record P-fin (f : A âŸª Î£ âŸ«) (n : â„•) : Set where
        constructor P-fin[_,_,_]
        field
            gen : Vec (A âŸª Î£ âŸ«) n
            memb : f âˆˆ[ gen ]
            closed : âˆ€ a {g} â†’ g âˆˆ[ gen ] â†’ Î´ g a âˆˆ[ gen ]

        elem : A âŸª Î£ âŸ«
        elem = f

    open P-fin
```

## Working definition

We now present a more convenient definition of `P`-finite series,
which will be our working definition for the rest of the document.

The working definition is more restrictive since it requires closure under left derivatives only for the generators
(instead for all elements of the algebra).

```
module SimplifiedDefinition where

    infix 3 P-fin[_,_,_]
    record P-fin (f : A âŸª Î£ âŸ«) (n : â„•) : Set where
        constructor P-fin[_,_,_]
        field
            gen : Vec (A âŸª Î£ âŸ«) n
            memb : f âˆˆ[ gen ]
            closed : âˆ€ a {g} â†’ g âˆˆ gen â†’ Î´ g a âˆˆ[ gen ]

        elem : A âŸª Î£ âŸ«
        elem = f
```

## Equivalence of the two definitions

Before proceeding, we show that the two definitions are in fact equivalent.

```
module EquivalenceOfDefinitions where

    open SimplifiedDefinition
    open OfficialDefinition renaming (P-fin to P-finâ€²; P-fin[_,_,_] to P-finâ€²[_,_,_])
    open P-fin public
```

The simplified definition is a special case of the official one,
so one direction is easy to prove.

```
    officialâ†’simplified :
        P-finâ€² f n â†’ P-fin f n

    officialâ†’simplified P-finâ€²[ gen , fâˆˆ[gen] , clâ€² ] =
        P-fin[ gen , fâˆˆ[gen] , cl ] where
            cl :  âˆ€ a {g} â†’ g âˆˆ gen â†’ Î´ g a âˆˆ[ gen ]
            cl a gâˆˆgen = clâ€² a (genâˆˆ gâˆˆgen)
```

For the other direction, we will use the following auxiliary lemma

```
    Î´-closed :
        âˆ€ (F : P-fin f n) a {g} â†’
        g âˆˆ[ gen F ] â†’
        -------------------------
        Î´ g a âˆˆ[ gen F ]
```

It says that the algebra generated by the generators of a `P`-finite series (in the simplified sense)
is closed under left derivatives.

With this lemma in hand, it is easy to show that the simplified definition implies the official one.

```
    simplifiedâ†’official :
        P-fin f n â†’ P-finâ€² f n

    simplifiedâ†’official F = P-finâ€²[ gen F , memb F , Î´-closed F ] 
```

We conclude by proving the auxiliary lemma.

```
    Î´-closed F a = go where
        go : âˆ€ {g} â†’ g âˆˆ[ gen F ] â†’ Î´ g a âˆˆ[ gen F ]
        go ğŸ˜âˆˆ = ğŸ˜âˆˆ
        go (genâˆˆ gâˆˆgen) = closed F a gâˆˆgen
        go (c Â·âˆˆ gâˆˆ[F]) = c Â·âˆˆ go gâˆˆ[F]
        go (gâˆˆ[F] +âˆˆ hâˆˆ[F]) = go gâˆˆ[F] +âˆˆ go hâˆˆ[F]
        go (_*âˆˆ_ {g} {h} gâˆˆ[gen] hâˆˆ[gen]) = subalgebra P ass where
            ass : (x : Var 4) â†’ lookup (g âˆ· Î´ g a âˆ· h âˆ· Î´ h a âˆ· []) x âˆˆ[ gen F ]
            ass zero = gâˆˆ[gen]
            ass (suc zero) = go gâˆˆ[gen]
            ass (suc (suc zero)) = hâˆˆ[gen]
            ass (suc (suc (suc zero))) = go hâˆˆ[gen]
        go (fâ‰ˆg â‰ˆâˆˆ fâˆˆ[F]) = (Î´-â‰ˆ fâ‰ˆg a) â‰ˆâˆˆ go fâˆˆ[F]
```

Therefore, from now on we work with the simplified definition.

```             
open SimplifiedDefinition public
open EquivalenceOfDefinitions using (Î´-closed) public
open P-fin public
```

# Closure properties of `P`-finite series {#sec:P-finite-closure-properties}

We show some natural closure properties for the class of `P`-finite series.
The use of the simplified definition makes the proofs easier.

In the proofs we will use the following auxiliary properties, which will be proved [at the end](#appendix).

```
_++-gen_ : P-fin f m â†’ P-fin g n â†’ Vec (A âŸª Î£ âŸ«) (m +â„• n)
F ++-gen G = gen F ++ gen G

_++-memb-+_ : (F : P-fin f m) (G : P-fin g n) â†’ elem F + elem G âˆˆ[ F ++-gen G ]
_++-memb-*_ : (F : P-fin f m) (G : P-fin g n) â†’ elem F * elem G âˆˆ[ F ++-gen G ]
_++-closed_ : âˆ€ (F : P-fin f m) (G : P-fin g n) a {h} â†’ h âˆˆ (F ++-gen G) â†’
    Î´ h a âˆˆ[ F ++-gen G ]
```

## Zero

The zero series `ğŸ˜` is `P`-finite for the empty tuple of generators.

```
P-fin-ğŸ˜ : P-fin ğŸ˜ 0
P-fin-ğŸ˜ = P-fin[ [] , ğŸ˜âˆˆ , (Î» a {g} ()) ]
```

## Scalar multiplication

`P`-finite series are closed under scalar multiplication.
We use the same set of generators.

```
P-fin-Â· : 
    P-fin f n â†’
    ----------------
    P-fin (c Â· f) n

P-fin-Â· F = P-fin[ gen F , _ Â·âˆˆ memb F , closed F ]
```

## Addition

`P`-finite series are closed under addition.
The set of generators is the concatenation of generators.

```
P-fin-+ :
    P-fin f m â†’
    P-fin g n â†’
    ----------------------
    P-fin (f + g) (m +â„• n)

P-fin-+ F G = P-fin[ F ++-gen G , F ++-memb-+ G , F ++-closed G ]
```

## Multiplication

`P`-finite series are closed under multiplication.
The set of generators is the concatenation of generators.

```
P-fin-* :
    P-fin f m â†’
    P-fin g n â†’
    ----------------------
    P-fin (f * g) (m +â„• n)

P-fin-* F G = P-fin[ F ++-gen G , F ++-memb-* G , F ++-closed G ]
```

The previous closure properties can be aggregated
by saying that, for every term,
if each variable evaluates to a `P`-finite series,
then the whole term evaluates to a `P`-finite series too.

## Left derivatives

`P`-finite series are closed under left derivatives.
The set of generators does not change.

```
P-fin-Î´ :
    P-fin f m â†’
    âˆ€ a â†’
    ---------------
    P-fin (Î´ f a) m

P-fin-Î´ F a = P-fin[ gen F , Î´-closed F a (memb F) , closed F ]
```

## Left anti-derivatives

When the alphabet `Î£` is finite, we can also show that `P`-finite series are closed under left anti-derivatives.
This is elaborated in a [separate section](../FinitelyGenerated-AntiDerivatives).

# Appendix

We prove here the auxiliary lemmas used in the closure properties.

```
++-âˆˆË¡ : âˆ€ {fs : Vec (A âŸª Î£ âŸ«) m} {gs : Vec (A âŸª Î£ âŸ«) n} â†’ f âˆˆ[ fs ] â†’ f âˆˆ[ fs ++ gs ]
++-âˆˆË¡ ğŸ˜âˆˆ = ğŸ˜âˆˆ
++-âˆˆË¡ (genâˆˆ fâˆˆfs) = genâˆˆ (âˆˆ-++âºË¡ fâˆˆfs)
++-âˆˆË¡ (c Â·âˆˆ fâˆˆ[fs]) = c Â·âˆˆ ++-âˆˆË¡ fâˆˆ[fs]
++-âˆˆË¡ (fâˆˆ[fs] +âˆˆ gâˆˆ[fs]) = ++-âˆˆË¡ fâˆˆ[fs] +âˆˆ ++-âˆˆË¡ gâˆˆ[fs]
++-âˆˆË¡ (fâˆˆ[fs] *âˆˆ gâˆˆ[fs]) = ++-âˆˆË¡ fâˆˆ[fs] *âˆˆ ++-âˆˆË¡ gâˆˆ[fs]
++-âˆˆË¡ (fâ‰ˆg â‰ˆâˆˆ gâˆˆ[fs]) = fâ‰ˆg â‰ˆâˆˆ ++-âˆˆË¡ gâˆˆ[fs]

++-âˆˆÊ³ : âˆ€ {fs : Vec (A âŸª Î£ âŸ«) m} {gs : Vec (A âŸª Î£ âŸ«) n} â†’ f âˆˆ[ gs ] â†’ f âˆˆ[ fs ++ gs ]
++-âˆˆÊ³ ğŸ˜âˆˆ = ğŸ˜âˆˆ
++-âˆˆÊ³ (genâˆˆ fâˆˆfs) = genâˆˆ (âˆˆ-++âºÊ³ _ fâˆˆfs)
++-âˆˆÊ³ (c Â·âˆˆ fâˆˆ[fs]) = c Â·âˆˆ ++-âˆˆÊ³ fâˆˆ[fs]
++-âˆˆÊ³ (fâˆˆ[fs] +âˆˆ gâˆˆ[fs]) = ++-âˆˆÊ³ fâˆˆ[fs] +âˆˆ ++-âˆˆÊ³ gâˆˆ[fs]
++-âˆˆÊ³ (fâˆˆ[fs] *âˆˆ gâˆˆ[fs]) = ++-âˆˆÊ³ fâˆˆ[fs] *âˆˆ ++-âˆˆÊ³ gâˆˆ[fs]
++-âˆˆÊ³ (fâ‰ˆg â‰ˆâˆˆ gâˆˆ[fs]) = fâ‰ˆg â‰ˆâˆˆ ++-âˆˆÊ³ gâˆˆ[fs]

F ++-memb-+ G = ++-âˆˆË¡ (memb F) +âˆˆ ++-âˆˆÊ³ ((memb G))
F ++-memb-* G = ++-âˆˆË¡ (memb F) *âˆˆ ++-âˆˆÊ³ (memb G)
   
_++-closed_ F G a hâˆˆfs++gs with âˆˆáµ¥-++ hâˆˆfs++gs
... | injâ‚ hâˆˆfs = ++-âˆˆË¡ (closed F a hâˆˆfs)
... | injâ‚‚ hâˆˆgs = ++-âˆˆÊ³ (closed G a hâˆˆgs)
```
