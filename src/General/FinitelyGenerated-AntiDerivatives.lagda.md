---
title: "Anti-derivatives of `P`-finite series"
---

```
{-# OPTIONS --guardedness --sized-types #-}
```

Let `Î£` be an alphabet of size `n`.
A series `f` is a *left anti-derivative* of series `gâ‚`, ..., `gâ‚™`
if for every `aáµ¢ : Î£`, the left derivative of `f` with respect to `aáµ¢` is `gáµ¢`.

We show that `P`-finite series are closed under anti-derivatives.
It is crucial that the input alphabet be finite.
For this reason, we prove it in a separate module,
since we need to reimport several definitions with a fixed finite alphabet.

```
open import Preliminaries.Base renaming (_,,_ to _,_)
open import General.ProductRules

module General.FinitelyGenerated-AntiDerivatives
    (R : CommutativeRing)
    (n : â„•) -- size of the alphabet
    (P : ProductRule R)
    where
```

Crucially, we fix the alphabet to be a *finite set* of size `n`.

```
Î£ = Fin n
```

```
open import Size

open import Preliminaries.Vector
open import Preliminaries.Algebra R

open import General.Series R Î£
open import General.Products R Î£
open import General.FinitelyGenerated R Î£ P

open Product P

private variable
    m k : â„•
    f g : A âŸª Î£ âŸ«
    fs gs : Vec (A âŸª Î£ âŸ«) m
```

The set of series generated by `f âˆ· fs` includes at least all the series generated by `fs`.

```
âˆ·-âˆˆ : g âˆˆ[ fs ] â†’ g âˆˆ[ f âˆ· fs ]
âˆ·-âˆˆ ğŸ˜âˆˆ = ğŸ˜âˆˆ
âˆ·-âˆˆ (genâˆˆ gâˆˆfs) = genâˆˆ (there gâˆˆfs)
âˆ·-âˆˆ (c Â·âˆˆ gâˆˆ[fs]) = c Â·âˆˆ âˆ·-âˆˆ gâˆˆ[fs]
âˆ·-âˆˆ (fâˆˆ[fs] +âˆˆ gâˆˆ[fs]) = âˆ·-âˆˆ fâˆˆ[fs] +âˆˆ âˆ·-âˆˆ gâˆˆ[fs]
âˆ·-âˆˆ (fâˆˆ[fs] *âˆˆ gâˆˆ[fs]) = âˆ·-âˆˆ fâˆˆ[fs] *âˆˆ âˆ·-âˆˆ gâˆˆ[fs]
âˆ·-âˆˆ (fâ‰ˆg â‰ˆâˆˆ gâˆˆ[fs]) = fâ‰ˆg â‰ˆâˆˆ âˆ·-âˆˆ gâˆˆ[fs]
```

We have a more general statement.

```
concat-âˆˆ : 
    {F : Vec (Vec (A âŸª Î£ âŸ«) m) k} â†’
    f âˆˆ[ fs ] â†’
    fs âˆˆ F â†’
    ------------------------------
    f âˆˆ[ concat F ]

concat-âˆˆ fâˆˆ[fs] (here px) rewrite px = ++-âˆˆË¡ fâˆˆ[fs]
concat-âˆˆ {F = F} fâˆˆ[fs] (there fsâˆˆF) with concat-âˆˆ fâˆˆ[fs] fsâˆˆF
... | fâˆˆ[F] = ++-âˆˆÊ³ fâˆˆ[F]
```

We now show that `P`-finite series are closed under left anti-derivatives.
More precisely, we show that, if all left derivatives `Î´ f a` of `f` are `P`-finite,
then `f` itself is `P`-finite.

```
P-fin-Î´â»Â¹ :
    (âˆ€ a â†’ P-fin (Î´ f a) m) â†’
    --------------------------
    P-fin f (1 +â„• n +â„• n *â„• m)
```

For simplicity, we assume that `Î´ f a` is `P`-finite with `m` generators for every `a : Î£`.
One could have the number of generators `m` depend on `a`,
but this would complicate the notation without adding much insight.

The idea of the proof is to take as generators `f` itself,
all its left derivatives `Î´ f a` (term `Î´f` below),
and all the generators witnessing that the left derivatives are `P`-finite (term `F` below).

```
P-fin-Î´â»Â¹ {f} {m} ass =
    P-fin[ f âˆ· Î´f ++ concat F , genâˆˆ (here refl) , lem ]
    where

    Î´f : Vec (A âŸª Î£ âŸ«) n
    Î´f = tabulate $ Î´ f

    Î´faâˆˆÎ´f : âˆ€ a â†’ Î´ f a âˆˆ Î´f
    Î´faâˆˆÎ´f = âˆˆ-tabulateâº (Î´ f)

    genâ€² : Î£ â†’ Vec (A âŸª Î£ âŸ«) m
    genâ€² a = gen $ ass a

    F : Vec (Vec (A âŸª Î£ âŸ«) m) n
    F = tabulate genâ€²

    lemâ€² : âˆ€ {g a b} â†’ g âˆˆ[ genâ€² b ] â†’ Î´ g a âˆˆ[ concat F ]
    lemâ€² {g} {a} {b} gâˆˆ[gen] = concat-âˆˆ Î´gaâˆˆ[gen] (âˆˆ-tabulateâº genâ€² b)
        where

        Î´gaâˆˆ[gen] : Î´ g a âˆˆ[ genâ€² b ]
        Î´gaâˆˆ[gen] = Î´-closed (ass b) a gâˆˆ[gen]

    lem :
        âˆ€ a {g} â†’
        g âˆˆ f âˆ· Î´f ++ concat F â†’
        -----------------------------
        Î´ g a âˆˆ[ f âˆ· Î´f ++ concat F ]

    lem a {g} (here gâ‰¡f) rewrite gâ‰¡f = genâˆˆ $ there $ âˆˆ-++âºË¡ (Î´faâˆˆÎ´f a)

    lem a {g} (there gâˆˆÎ´f++F)
        with âˆˆáµ¥-++ {a = g} {as = Î´f} {bs = concat F} gâˆˆÎ´f++F
    ... | injâ‚ gâˆˆÎ´f
        with âˆˆ-tabulateâ» gâˆˆÎ´f
    lem a {g} (there gâˆˆÎ´f++F) | injâ‚ gâˆˆÎ´f | b , gâ‰¡Î´fb
        = âˆ·-âˆˆ $ ++-âˆˆÊ³ $ lemâ€² gâˆˆ[gen]
        where

        gâˆˆ[gen] : g âˆˆ[ genâ€² b ]
        gâˆˆ[gen] rewrite gâ‰¡Î´fb = memb (ass b)

    lem a {g} (there gâˆˆÎ´f++F) | injâ‚‚ gâˆˆconcatF
        with concat-âˆˆâ» {ass = F} gâˆˆconcatF
    ... | gs , gsâˆˆF , gâˆˆgs
        with âˆˆ-tabulateâ» gsâˆˆF
    ... | b , gsâ‰¡genb
        = âˆ·-âˆˆ $ ++-âˆˆÊ³ $ lemâ€² gâˆˆ[gen]
        where

        gâˆˆ[gen] : g âˆˆ[ genâ€² b ]
        gâˆˆ[gen] rewrite gsâ‰¡genb = genâˆˆ gâˆˆgs
```
